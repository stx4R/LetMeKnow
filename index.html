import streamlit as st
import pandas as pd
import datetime
import os

# --- ì„¤ì • ë° ë°ì´í„° ê´€ë¦¬ ---
CSV_FILE = 'issues.csv'

def load_data():
    if not os.path.exists(CSV_FILE):
        return pd.DataFrame(columns=['ID', 'ë‚ ì§œ', 'ë‚´ìš©', 'ìƒíƒœ', 'ì½”ë©˜íŠ¸'])
    return pd.read_csv(CSV_FILE)

def save_data(df):
    df.to_csv(CSV_FILE, index=False)

# --- í† ìŠ¤(Toss) ìŠ¤íƒ€ì¼ CSS ì ìš© ---
def local_css():
    st.markdown("""
        <style>
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');
        
        html, body, [class*="css"] {
            font-family: 'Pretendard', sans-serif;
            background-color: #F9FAFB;
            color: #191F28;
        }
        
        .main-header {
            font-size: 2.5rem;
            font-weight: 800;
            color: #191F28;
            margin-bottom: 0.5rem;
        }
        .sub-header {
            font-size: 1.1rem;
            color: #8B95A1;
            margin-bottom: 2rem;
        }
        
        .stTextArea textarea {
            background-color: #FFFFFF;
            border-radius: 12px;
            border: 1px solid #E5E8EB;
        }
        
        .stButton button {
            background-color: #3182F6;
            color: white;
            border-radius: 12px;
            border: none;
            padding: 12px 20px;
            font-weight: 600;
            width: 100%;
        }
        .stButton button:hover {
            background-color: #1B64DA;
            color: white;
        }
        </style>
    """, unsafe_allow_html=True)

# --- ë©”ì¸ ì•± ë¡œì§ ---
def main():
    st.set_page_config(page_title="ì•Œë ¤ì¤˜", page_icon="ğŸ“¢", layout="centered")
    local_css()

    if 'logged_in' not in st.session_state:
        st.session_state['logged_in'] = False

    col1, col2 = st.columns([8, 2])
    with col1:
        st.markdown('<div class="main-header">ğŸ“¢ ì•Œë ¤ì¤˜</div>', unsafe_allow_html=True)
        st.markdown('<div class="sub-header">ìš°ë¦¬ ë°˜ì˜ ë” ë‚˜ì€ ë‚´ì¼ì„ ìœ„í•´, ë¬´ì—‡ì´ë“  ë§í•´ì£¼ì„¸ìš”.</div>', unsafe_allow_html=True)
    with col2:
        if not st.session_state['logged_in']:
            with st.popover("ê°œë°œì ë¡œê·¸ì¸"):
                user_id = st.text_input("ì•„ì´ë””")
                user_pw = st.text_input("ë¹„ë°€ë²ˆí˜¸", type="password")
                if st.button("ì ‘ì†"):
                    if user_id == "D3v310p3r" and user_pw == "12345678":
                        st.session_state['logged_in'] = True
                        st.success("ë¡œê·¸ì¸ ì„±ê³µ!")
                        st.rerun()
                    else:
                        st.error("ì •ë³´ ë¶ˆì¼ì¹˜")
        else:
            if st.button("ë¡œê·¸ì•„ì›ƒ"):
                st.session_state['logged_in'] = False
                st.rerun()

    df = load_data()

    if st.session_state['logged_in']:
        st.info("ğŸ”§ ê°œë°œì ëª¨ë“œ: ê±´ì˜ì‚¬í•­ ê´€ë¦¬")
        if df.empty:
            st.write("ë“±ë¡ëœ ê±´ì˜ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.")
        else:
            for index, row in df[::-1].iterrows():
                with st.container():
                    st.markdown(f"""
                    <div style="background-color:white; padding:20px; border-radius:15px; margin-bottom:15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
                        <div style="font-size:0.9rem; color:#8B95A1;">{row['ë‚ ì§œ']} | ID: {row['ID']}</div>
                        <div style="font-size:1.2rem; font-weight:bold; margin: 10px 0;">{row['ë‚´ìš©']}</div>
                        <div>ìƒíƒœ: <b>{row['ìƒíƒœ']}</b></div>
                        <div style="color:#3182F6;">ì½”ë©˜íŠ¸: {row['ì½”ë©˜íŠ¸']}</div>
                    </div>
                    """, unsafe_allow_html=True)
                    
                    c1, c2, c3, c4 = st.columns([2, 2, 2, 4])
                    if c1.button("í•´ê²°", key=f"s_{index}"):
                        df.at[index, 'ìƒíƒœ'] = "âœ… í•´ê²° ì™„ë£Œ"
                        save_data(df)
                        st.rerun()
                    if c2.button("ë³´ë¥˜", key=f"h_{index}"):
                        df.at[index, 'ìƒíƒœ'] = "â¸ ë³´ë¥˜"
                        save_data(df)
                        st.rerun()
                    if c3.button("ë¯¸ê²°", key=f"u_{index}"):
                        df.at[index, 'ìƒíƒœ'] = "ğŸ”¥ í•´ê²° ë¯¸ì™„ë£Œ"
                        save_data(df)
                        st.rerun()
                    
                    new_com = c4.text_input("ë‹µë³€", key=f"c_{index}")
                    if new_com:
                        df.at[index, 'ì½”ë©˜íŠ¸'] = new_com
                        save_data(df)
                        st.rerun()
                st.divider()

    else:
        with st.container():
            st.markdown("### ğŸ“ ë¬¸ì œì  ê±´ì˜í•˜ê¸°")
            with st.form("suggestion_form", clear_on_submit=True):
                content = st.text_area("ë‚´ìš© ì…ë ¥", height=100)
                if st.form_submit_button("ë³´ë‚´ê¸°") and content:
                    new_id = len(df) + 1
                    now = datetime.datetime.now().strftime("%Y-%m-%d %H:%M")
                    new_data = pd.DataFrame({'ID': [new_id], 'ë‚ ì§œ': [now], 'ë‚´ìš©': [content], 'ìƒíƒœ': ['ì ‘ìˆ˜ ëŒ€ê¸°'], 'ì½”ë©˜íŠ¸': ['-']})
                    df = pd.concat([df, new_data], ignore_index=True)
                    save_data(df)
                    st.success("ì „ì†¡ ì™„ë£Œ!")
                    st.rerun()

        st.markdown("---")
        if not df.empty:
            for _, row in df[::-1].iterrows():
                st.markdown(f"""
                <div style="background-color:white; padding:20px; border-radius:15px; margin-bottom:15px; border:1px solid #E5E8EB;">
                    <span style="font-weight:bold; color:#3182F6;">{row['ìƒíƒœ']}</span>
                    <div style="font-size:1.1rem; margin:10px 0;">{row['ë‚´ìš©']}</div>
                    <div style="background-color:#F2F4F6; padding:10px; border-radius:8px; font-size:0.9rem;">
                        <b>ë‹µë³€:</b> {row['ì½”ë©˜íŠ¸']}
                    </div>
                </div>
                """, unsafe_allow_html=True)

if __name__ == "__main__":
    main()
