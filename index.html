import streamlit as st
import pandas as pd
import datetime
import os

# --- ì„¤ì • ë° ë°ì´í„° ê´€ë¦¬ ---
CSV_FILE = 'issues.csv'

def load_data():
    if not os.path.exists(CSV_FILE):
        return pd.DataFrame(columns=['ID', 'ë‚ ì§œ', 'ë‚´ìš©', 'ìƒíƒœ', 'ì½”ë©˜íŠ¸'])
    return pd.read_csv(CSV_FILE)

def save_data(df):
    df.to_csv(CSV_FILE, index=False)

# --- í† ìŠ¤(Toss) ìŠ¤íƒ€ì¼ CSS ì ìš© ---
def local_css():
    st.markdown("""
        <style>
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');
        
        html, body, [class*="css"] {
            font-family: 'Pretendard', sans-serif;
            background-color: #F9FAFB;
            color: #191F28;
        }
        
        /* í—¤ë” ìŠ¤íƒ€ì¼ */
        .main-header {
            font-size: 2.5rem;
            font-weight: 800;
            color: #191F28;
            margin-bottom: 0.5rem;
        }
        .sub-header {
            font-size: 1.1rem;
            color: #8B95A1;
            margin-bottom: 2rem;
        }
        
        /* ì…ë ¥ í¼ ìŠ¤íƒ€ì¼ */
        .stTextArea textarea {
            background-color: #FFFFFF;
            border-radius: 12px;
            border: 1px solid #E5E8EB;
        }
        
        /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ (í† ìŠ¤ ë¸”ë£¨) */
        .stButton button {
            background-color: #3182F6;
            color: white;
            border-radius: 12px;
            border: none;
            padding: 12px 20px;
            font-weight: 600;
            width: 100%;
        }
        .stButton button:hover {
            background-color: #1B64DA;
            color: white;
        }
        
        /* ìƒíƒœ ë°°ì§€ ìŠ¤íƒ€ì¼ */
        .status-badge {
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        </style>
    """, unsafe_allow_html=True)

# --- ë©”ì¸ ì•± ë¡œì§ ---
def main():
    st.set_page_config(page_title="ì•Œë ¤ì¤˜", page_icon="ğŸ“¢", layout="centered")
    local_css()

    # ì„¸ì…˜ ìƒíƒœ ì´ˆê¸°í™”
    if 'logged_in' not in st.session_state:
        st.session_state['logged_in'] = False

    # ìƒë‹¨ í—¤ë” ë° ê°œë°œì ë¡œê·¸ì¸ ë²„íŠ¼ (ì»¬ëŸ¼ìœ¼ë¡œ ë°°ì¹˜)
    col1, col2 = st.columns([8, 2])
    with col1:
        st.markdown('<div class="main-header">ğŸ“¢ ì•Œë ¤ì¤˜</div>', unsafe_allow_html=True)
        st.markdown('<div class="sub-header">ìš°ë¦¬ ë°˜ì˜ ë” ë‚˜ì€ ë‚´ì¼ì„ ìœ„í•´, ë¬´ì—‡ì´ë“  ë§í•´ì£¼ì„¸ìš”.</div>', unsafe_allow_html=True)
    with col2:
        # ë¡œê·¸ì¸ ìƒíƒœê°€ ì•„ë‹ ë•Œë§Œ ë¡œê·¸ì¸ ë²„íŠ¼/íŒì—… í‘œì‹œ
        if not st.session_state['logged_in']:
            with st.popover("ê°œë°œì ë¡œê·¸ì¸"):
                user_id = st.text_input("ì•„ì´ë””")
                user_pw = st.text_input("ë¹„ë°€ë²ˆí˜¸", type="password")
                if st.button("ì ‘ì†"):
                    if user_id == "D3v310p3r" and user_pw == "12345678":
                        st.session_state['logged_in'] = True
                        st.success("ë¡œê·¸ì¸ ì„±ê³µ!")
                        st.rerun()
                    else:
                        st.error("ì •ë³´ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.")
        else:
            if st.button("ë¡œê·¸ì•„ì›ƒ"):
                st.session_state['logged_in'] = False
                st.rerun()

    # --- íƒ­ êµ¬ë¶„ (ì¼ë°˜ ì‚¬ìš©ì / ê°œë°œì) ---
    # ì‹¤ì œë¡œëŠ” íƒ­ ëŒ€ì‹  ë¡œê·¸ì¸ ì—¬ë¶€ì— ë”°ë¼ í™”ë©´ì„ ë‹¤ë¥´ê²Œ ë³´ì—¬ì¤ë‹ˆë‹¤.
    
    df = load_data()

    # 1. ê´€ë¦¬ì(ê°œë°œì) í™”ë©´
    if st.session_state['logged_in']:
        st.info("ğŸ”§ ê°œë°œì ëª¨ë“œì…ë‹ˆë‹¤. ê±´ì˜ì‚¬í•­ì„ ê´€ë¦¬í•˜ì„¸ìš”.")
        
        if df.empty:
            st.write("ì•„ì§ ë“±ë¡ëœ ê±´ì˜ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.")
        else:
            # ìµœì‹ ìˆœ ì •ë ¬
            for index, row in df[::-1].iterrows():
                with st.container():
                    st.markdown(f"""
                    <div style="background-color:white; padding:20px; border-radius:15px; margin-bottom:15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
                        <div style="font-size:0.9rem; color:#8B95A1;">{row['ë‚ ì§œ']} | ID: {row['ID']}</div>
                        <div style="font-size:1.2rem; font-weight:bold; margin: 10px 0;">{row['ë‚´ìš©']}</div>
                        <div style="margin-top:10px;"><b>í˜„ì¬ ìƒíƒœ:</b> {row['ìƒíƒœ']}</div>
                        <div style="margin-top:5px; color:#3182F6;"><b>ê°œë°œì ì½”ë©˜íŠ¸:</b> {row['ì½”ë©˜íŠ¸']}</div>
                    </div>
                    """, unsafe_allow_html=True)
                    
                    # ê´€ë¦¬ ê¸°ëŠ¥ (ìƒíƒœ ë³€ê²½ ë° ì½”ë©˜íŠ¸)
                    c1, c2, c3, c4 = st.columns([2, 2, 2, 4])
                    if c1.button("í•´ê²° ì™„ë£Œ", key=f"sol_{index}"):
                        df.at[index, 'ìƒíƒœ'] = "âœ… í•´ê²° ì™„ë£Œ"
                        save_data(df)
                        st.rerun()
                    if c2.button("ë³´ë¥˜", key=f"hold_{index}"):
                        df.at[index, 'ìƒíƒœ'] = "â¸ ë³´ë¥˜"
                        save_data(df)
                        st.rerun()
                    if c3.button("ë¯¸ì™„ë£Œ", key=f"unsol_{index}"):
                        df.at[index, 'ìƒíƒœ'] = "ğŸ”¥ í•´ê²° ë¯¸ì™„ë£Œ"
                        save_data(df)
                        st.rerun()
                    
                    new_comment = c4.text_input("ì½”ë©˜íŠ¸ ë‹¬ê¸°", key=f"com_{index}", placeholder="ë‹µë³€ì„ ì…ë ¥ í›„ ì—”í„°")
                    if new_comment:
                        df.at[index, 'ì½”ë©˜íŠ¸'] = new_comment
                        save_data(df)
                        st.rerun()
                st.divider()

    # 2. ì¼ë°˜ ì‚¬ìš©ì í™”ë©´ (ê±´ì˜í•˜ê¸° & ëª©ë¡ ë³´ê¸°)
    else:
        # ê±´ì˜í•˜ê¸° í¼
        with st.container():
            st.markdown("### ğŸ“ ë¬¸ì œì  ê±´ì˜í•˜ê¸°")
            with st.form("suggestion_form", clear_on_submit=True):
                content = st.text_area("ì–´ë–¤ ë¬¸ì œê°€ ìˆë‚˜ìš”?", height=150, placeholder="ì˜ˆ: ì¹ íŒ ì§€ìš°ê°œê°€ ë„ˆë¬´ ë‚¡ì•˜ì–´ìš”.")
                submitted = st.form_submit_button("ë³´ë‚´ê¸°")
                
                if submitted and content:
                    new_id = len(df) + 1
                    now = datetime.datetime.now().strftime("%Y-%m-%d %H:%M")
                    new_data = pd.DataFrame({
                        'ID': [new_id],
                        'ë‚ ì§œ': [now],
                        'ë‚´ìš©': [content],
                        'ìƒíƒœ': ['ì ‘ìˆ˜ ëŒ€ê¸°'],
                        'ì½”ë©˜íŠ¸': ['-']
                    })
                    df = pd.concat([df, new_data], ignore_index=True)
                    save_data(df)
                    st.success("ì†Œì¤‘í•œ ì˜ê²¬ì´ ì „ë‹¬ë˜ì—ˆìŠµë‹ˆë‹¤!")
                    st.rerun()

        st.markdown("---")
        st.markdown("### ğŸ‘€ ê±´ì˜í•¨ ëª©ë¡")
        
        if df.empty:
            st.write("ì•„ì§ ë“±ë¡ëœ ê±´ì˜ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤. ì²« ë²ˆì§¸ ì˜ê²¬ì„ ë‚¨ê²¨ì£¼ì„¸ìš”!")
        else:
            # ê³µê°œëœ ëª©ë¡ ë³´ê¸° (ì½ê¸° ì „ìš©)
            for _, row in df[::-1].iterrows():
                status_color = "#333"
                if "ì™„ë£Œ" in row['ìƒíƒœ']: status_color = "#3182F6" # Blue
                elif "ë³´ë¥˜" in row['ìƒíƒœ']: status_color = "#FFB300" # Amber
                elif "ë¯¸ì™„ë£Œ" in row['ìƒíƒœ']: status_color = "#F04452" # Red

                st.markdown(f"""
                <div style="background-color:white; padding:20px; border-radius:15px; margin-bottom:15px; border: 1px solid #E5E8EB;">
                    <span style="background-color:{status_color}; color:white; padding:4px 8px; border-radius:6px; font-size:0.8rem;">{row['ìƒíƒœ']}</span>
                    <span style="float:right; color:#8B95A1; font-size:0.8rem;">{row['ë‚ ì§œ']}</span>
                    <div style="font-size:1.1rem; font-weight:600; margin-top:10px; margin-bottom:10px;">{row['ë‚´ìš©']}</div>
                    <div style="background-color:#F2F4F6; padding:10px; border-radius:8px; font-size:0.9rem; color:#4E5968;">
                        <b>ğŸ‘¨â€ğŸ’» ê°œë°œì ë‹µë³€:</b> {row['ì½”ë©˜íŠ¸']}
                    </div>
                </div>
                """, unsafe_allow_html=True)

if __name__ == "__main__":
    main()
